Tráº§n Äá»©c ductnn Follow 7 1 1 Published about 16 hours ago 6 min read 25 0 0 Triá»ƒn_khai EFK Stack trÃªn Kubernetes Happy New Year Report EFK stack on K8S Giá»›i_thiá»‡u Má»™t há»‡_thá»‘ng cÃ³_thá»ƒ cháº¡y nhiá»u dá»‹ch_vá»¥ hoáº·c á»©ng_dá»¥ng khÃ¡c_nhau vÃ¬_váº­y viá»‡c theo_dÃµi há»‡_thá»‘ng lÃ  vÃ´_cÃ¹ng cáº§n_thiáº¿t
Logging lÃ  má»™t cÃ´ng_cá»¥ Ä‘Æ¡n_giáº£n nhÆ°ng láº¡i ráº¥t tiá»‡n_lá»£i giÃºp ghi_láº¡i toÃ n_bá»™ hoáº¡t_Ä‘á»™ng cá»§a há»‡_thá»‘ng
Nhá»_cÃ³ logging ta cÃ³_thá»ƒ tra_cá»©u láº¡i tráº¡ng_thÃ¡i cá»§a há»‡_thá»‘ng trong quÃ¡_khá»© vÃ  cÃ³_thá»ƒ tÃ¬m vÃ  fix láº¡i lá»—i dá»…_dÃ ng hÆ¡n
Hiá»‡n_nay Ä‘Ã£ cÃ³ khÃ¡ nhiá»u cÃ´ng_cá»¥ Ä‘á»ƒ quáº£n_lÃ½ log khÃ¡c_nhau
Trong bÃ i_viáº¿t nÃ y mÃ¬nh sáº½ Ä‘á»_cáº­p Ä‘áº¿n bá»™ cÃ´ng_cá»¥ EFKElasticsearch-Fluentbit-Kibana
EFK cÃ³ ráº¥t nhiá»u Æ°u_Ä‘iá»ƒm nhÆ° pháº§n_má»m mÃ£ nguá»“n má»Ÿ hoÃ n_toÃ n miá»…n_phÃ­ ğŸ˜ğŸ˜ğŸ˜ vÃ  ráº¥t dá»… xÃ i_ná»¯a
BÃ¢y_giá» mÃ¬nh sáº½ giá»›i_thiá»‡u cho anh_em bá»™ cÃ´ng_cá»¥ nÃ y vÃ  mÃ¬nh dÃ¹ng Ä‘á»ƒ demo theo_dÃµi log cá»§a cá»¥m kubernetes
OK


VÃ o thÃ´i
EFK stack lÃ  táº­p_há»£p cá»§a 3 pháº§n_má»m Ä‘i chung vá»›i_nhau bao_gá»“m Elasticsearch CÆ¡_sá»Ÿ dá»¯_liá»‡u NoSQL dÃ¹ng Ä‘á»ƒ lÆ°u_trá»¯ dá»¯_liá»‡u vÃ  cung_cáº¥p interface Ä‘á»ƒ tÃ¬m_kiáº¿m vÃ  query log
Fluent-bit LÃ  pháº§n_má»m mÃ£ nguá»“n má»Ÿ viáº¿t báº±ng C Ä‘Æ°á»£c thiáº¿t_káº¿ nháº±m chÃº_trá»ng Ä‘áº¿n hiá»‡u_suáº¥t
NÃ³ cho_phÃ©p báº¡n thu_tháº­p logs tá»« nhiá»u nguá»“n khÃ¡c_nhau
Fluent bit Ä‘Æ°á»£c phÃ¡t_triá»ƒn bá»Ÿi Fluentd team vá»›i má»¥c_Ä‘Ã­ch táº¡o_ra má»™t phiÃªn_báº£n lightweight trong viá»‡c xá»­_lÃ½ logs
Sau_Ä‘Ã³ fluent bit Ä‘Æ°á»£c sá»­_dá»¥ng nhÆ° má»™t giáº£i_phÃ¡p xá»­_lÃ½ dÃ nh cho Cloud
Kibana Giao_diá»‡n Ä‘á»ƒ quáº£n_lÃ½ thá»‘ng_kÃª logs
CÃ³ nhiá»‡m_vá»¥ Ä‘á»c thÃ´ng_tin tá»« elasticsearch
CÆ¡_cháº¿ hoáº¡t_Ä‘á»™ng cá»§a bá»™ cÃ´ng_cá»¥ Ä‘Æ°á»£c mÃ´_táº£ qua hÃ¬nh dÆ°á»›i Ä‘Ã¢y Äáº§u_tiÃªn log sáº½ Ä‘Æ°á»£c Ä‘Æ°a_Ä‘áº¿n Fluent-bit
Fluent-bit sáº½ Ä‘á»c nhá»¯ng log nÃ y thÃªm nhá»¯ng thÃ´ng_tin nhÆ° thá»i_gian IP parse dá»¯ liá»‡u tá»« log server nÃ o_Ä‘á»™ nghiÃªm_trá»ng ná»™i_dung log vÃ  ghi xuá»‘ng Elasticsearch
Äá»ƒ xem log chÃºng_ta truy_cáº­p URL cá»§a Kibana
Kibana sáº½ Ä‘á»c thÃ´ng_tin log trong Elasticsearch hiá»ƒn_thá»‹ lÃªn giao_diá»‡n cho ngÆ°á»i_dÃ¹ng query vÃ  xá»­_lÃ½
BÃ¢y_giá» mÃ¬nh sáº½ Ä‘á» mÃ´ EFK stack cho Kubernetes Demo á» bÃ i_viáº¿t nÃ y mÃ¬nh sá»­_dá»¥ng minikube Ä‘á»ƒ deploy cá»¥m kubernetes vÃ¬_váº­y anh_em nÃ o chÆ°a cÃ i minikube thÃ¬ cÃ i nha ğŸ˜ğŸ˜ğŸ˜
Äá»ƒ cÃ i thÃ¬ anh_em cá»© vÃ´ trang_chá»§ xem thÃ´i cÅ©ng Ä‘Æ¡n_giáº£n thÃ´i
Anh_em sáº½ pháº£i cÃ i hai thá»© lÃ  minikube vÃ  set_up kubectl cho minikube mÃ¬nh Ä‘á»ƒ link cÃ i á»Ÿ_Ä‘Ã¢y cho ai lÆ°á»i tÃ¬m v
MÃ¬nh sáº½ demo theo thá»©_tá»± sau Elasticsearch - Kibana - Fluent bit
Source code mÃ¬nh sáº½ Ä‘á»ƒ á»Ÿ_Ä‘Ã¢y cho anh em tiá»‡n theo_dÃµi
BÆ°á»›c 1 Start cá»¥m minikube [emailÂ protected]~demo-EFK minikube startğŸ˜„ minikube v1
17
1 on Ubuntu 18
04ğŸ‰ minikube 1
18
1 is available
Download it httpsgithub
comkubernetesminikubereleasestagv1
18
1ğŸ’¡ To disable this notice run 'minikube config set WantUpdateNotification false'âœ¨ Automatically selected the docker driverğŸ‘ Starting control plane node minikube in cluster minikubeğŸ”¥ Creating docker container CPUs=2 Memory=2200MB


ğŸ³ Preparing Kubernetes v1
20
2 on Docker 20
10
2


â–ª Generating certificates and keys


â–ª Booting up control plane


â–ª Configuring RBAC rules


ğŸ” Verifying Kubernetes components


ğŸŒŸ Enabled addons storage-provisioner default-storageclassğŸ„ Done
kubectl is now configured to use minikube cluster and default namespace by default BÆ°á»›c 2 Táº¡o namespace chung_cho cá»¥m kubernetes [emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainkube-logging
yamlnamespacekube-logging created Kiá»ƒm_tra [emailÂ protected]~demo-EFK kubectl get nsNAME STATUS AGEdefault Active 2m24skube-logging Active 15skube-node-lease Active 2m25skube-public Active 2m25skube-system Active 2m25s Ta tháº¥y namespace kube-logging chung Ä‘Ã£ Ä‘Æ°á»£c táº¡o BÆ°á»›c 3 Deploy Elasticsearch
á» bÆ°á»›c nÃ y chung ta sáº½ deploy 2 pháº§n Ä‘áº§u_tiÃªn lÃ  service vÃ  statefuleset cá»§a elasticsearch
á» trong serivices mÃ¬nh sá»­_dá»¥ng type NodePort Ä‘á»ƒ dá»…_dÃ ng chá»c vÃ´ kiá»ƒm_tra nhÆ°ng cÃ¡ch nÃ y chá»‰ phá»¥c_vá»¥ demo cho dá»… thÃ´i chá»© khÃ´ng an_toÃ n vÃ¬ ai láº¡i Ä‘i choc vÃ´ DB tÃ¹y_tiá»‡n nhá»· ğŸ˜¸ğŸ’€ğŸ‘»
[emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainelastic-service
yamlserviceelasticsearch created[emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainelastic-statefulset
yamlstatefulset
appselasticsearch created Kiá»ƒm_tra [emailÂ protected]~demo-EFK kubectl get svc -n kube-loggingNAME TYPE CLUSTER-IP EXTERNAL-IP PORTS AGEelasticsearch NodePort 10
101
126
180 920031544TCP 54s[emailÂ protected]~demo-EFK kubectl get pods -n kube-loggingNAME READY STATUS RESTARTS AGEelasticsearch-0 11 Running 0 84s BÆ°á»›c 4 Deploy Kibana mÃ¬nh cÅ©ng sáº½ deploy giá»‘ng tháº±ng elasticsearch services váº«n sáº½ Ä‘á»ƒ type NodePort Ä‘á»ƒ tiá»‡n demo
[emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainkibana
ymlservicekibana createddeployment
appskibana created Kiá»ƒm_tra [emailÂ protected]~demo-EFK kubectl get svc -n kube-loggingNAME TYPE CLUSTER-IP EXTERNAL-IP PORTS AGEelasticsearch NodePort 10
101
126
180 920031544TCP 6m56skibana NodePort 10
103
245
24 560131122TCP 37s[emailÂ protected]~demo-EFK kubectl get pods -n kube-loggingNAME READY STATUS RESTARTS AGEelasticsearch-0 11 Running 0 7m16skibana-5d6849dc8c-kmf7l 11 Running 0 82s Sau_Ä‘Ã¢y lÃ  pháº§n quan_trá»ng nháº¥t deploy bÃ© Fluent-bit
MÃ¬nh sáº½ giáº£i_thÃ­ch ká»¹ qua cÃ¡c bÆ°á»›c deploy
Äáº§u_tiÃªn Ä‘á»ƒ thu_tháº­p logs tá»« cá»¥m kubernetes mÃ¬nh sáº½ pháº£i cáº¥p cho fluent-bit má»™t account vÃ  má»™t sá»‘ quyá»n nhÆ° [get list watch] Ä‘á»ƒ cÃ³_thá»ƒ quáº£n_lÃ½ logs
[emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainfluent-bit-service-account
ymlserviceaccountfluent-bit created[emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainfluent-bit-role
ymlWarning rbac
authorization
k8s
iov1beta1 ClusterRole is deprecated in v1
17+ unavailable in v1
22+; use rbac
authorization
k8s
iov1 ClusterRoleclusterrole
rbac
authorization
k8s
iofluent-bit-read created OK


Sau_Ä‘Ã³ ta cáº§n liÃªn_káº¿t ServiceAccount vá»›i ClusterRole vá»«a táº¡o á»Ÿ trÃªn [emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainfluent-bit-role-binding
ymlWarning rbac
authorization
k8s
iov1beta1 ClusterRoleBinding is deprecated in v1
17+ unavailable in v1
22+; use rbac
authorization
k8s
iov1 ClusterRoleBindingclusterrolebinding
rbac
authorization
k8s
iofluent-bit-read created Tiáº¿p_theo mÃ¬nh tiáº¿n_hÃ nh deploy file ConfigMap cá»§a fluent-bit
Anh_em cÃ³_thá»ƒ theo_dÃµi file ConfigMap cá»§a mÃ¬nh á»Ÿ_Ä‘Ã¢y
á» Ä‘Ã¢y mÃ¬nh sá»­_dá»¥ng 4 sections cá»§a fluent-bit [SERVICE] dÃ¹ng Ä‘á»ƒ táº¡o file logs
[INPUT] cáº¥u hÃ¬nh Ä‘áº§u vÃ o cá»§a nÆ¡i láº¥y logs
Pháº§n láº¥y logs mÃ¬nh láº¥y táº¡i thÆ°_má»¥c varlogcontainers
log trong cá»¥m minikube
Anh_em cÃ³_thá»ƒ cáº¥u hÃ¬nh file log mÃ  mÃ¬nh muá»‘n láº¥y VÃ­_dá»¥ etcd kube-api



[OUTPUT] cáº¥u hÃ¬nh Ä‘áº§u_ra file log lÃ  host vÃ  port cá»§a elasticsearch
[PARSER] cáº¥u hÃ¬nh file logs dáº¡ng json vÃ  time


Anh_em cÃ³_thá»ƒ tÃ¬m_hiá»ƒu thÃªm trÃªn docs cá»§a fluent-bit nhÃ¡
MÃ¬nh cáº¥u hÃ¬nh sÆ°Æ¡ng sÆ°Æ¡ng váº­y demo tiáº¿p thÃ´i 3 [emailÂ protected]~demo-EFK kubectl create -f httpsraw
githubusercontent
comductnndemo-EFKmainfluent-bit-configmap
ymlconfigmapfluent-bit-config created Cuá»‘i_cÃ¹ng lÃ  deploy file DaemonSet cá»§a fluent-bit
NhÆ°ng trÆ°á»›c_Ä‘Ã³ anh_em quay_láº¡i chá»— cá»§a elasticsearch Ä‘á»ƒ láº¥y_IP vÃ  cáº¥u hÃ¬nh vÃ o file DaemonSet cá»§a fluent-bit nhÆ°_sau Láº¥y IP cá»§a elasticsearch [emailÂ protected]~demo-EFK kubectl get svc -n kube-loggingNAME TYPE CLUSTER-IP EXTERNAL-IP PORTS AGEelasticsearch NodePort 10
101
126
180 920031544TCP 50m Cáº¥u hÃ¬nh vÃ o fluent-bit env- name FLUENT ELASTICSEARCH HOST value 10
101
126
180 OK


Xong_xuÃ´i rÃ´i deploy thÃ´i 3 [emailÂ protected]~demo-EFK kubectl create -f fluent-bit-ds-minikube
ymldaemonset
appsfluent-bit created Kiá»ƒm_tra [emailÂ protected]~demo-EFK kubectl get pods -n kube-loggingNAME READY STATUS RESTARTS AGEelasticsearch-0 11 Running 0 53mfluent-bit-fv4pm 11 Running 0 31skibana-5d6849dc8c-kmf7l 11 Running 0 47m Done


Kiá»ƒm_tra thÃ nh_quáº£ nÃ o
Anh_em check ip cá»§a cá»¥m minikube theo command minikube ip sau_Ä‘Ã³ check port cá»§a kibana qua command [emailÂ protected]~demo-EFK kubectl get svc -n kube-loggingNAME TYPE CLUSTER-IP EXTERNAL-IP PORTS AGEelasticsearch NodePort 10
101
126
180 920031544TCP 53mkibana NodePort 10
103
245
24 560131122TCP 47m Sau_Ä‘Ã³ má»Ÿ trÃ¬nh_duyá»‡t truy_cáº­p Ä‘á»‹a_chá»‰ minikube ip31122 Ä‘á»ƒ xem káº¿t_quáº£ Váº­y lÃ  mÃ¬nh lÃ  vá»«a demo xong EFK stack Ä‘á»ƒ theo_dÃµi logs cá»§a cá»¥m kubernetes
Hy_vá»ng bÃ i_viáº¿t nÃ y cá»§a mÃ¬nh sáº½ giÃºp anh hiá»ƒu Ä‘Æ°á»£c pháº§n_nÃ o cá»§a cÃ¡ch hoáº¡t_Ä‘á»™ng vÃ  lá»£i_Ã­ch cá»§a EFK ğŸ‰ğŸ‰ğŸ‰
Cáº£m_Æ¡n anh_em Ä‘Ã£ Ä‘á»c ğŸ˜„ğŸ˜„ğŸ˜„
References Setting up Fluent-bit Kubernetes Logging All Rights Reserved Report